<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>AIç¼–æ›²æˆæœ - ç«¥å¿ƒæ±‡èšÂ·å®¢å®¶ä¼ æƒ…</title>
  <!-- å¼•å…¥å­—ä½“ä¸å›¾æ ‡åº“ -->
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- å¼•å…¥æ ·å¼ -->
  <link rel="stylesheet" href='../æ•™è‚²æœåŠ¡&å…¬ç›Šå‚æ¼”/css/common.css'>
  <link rel="stylesheet" href="assets/css/ai.css">
  <!-- å¼•å…¥js -->
  <script src="assets/js/music_control.js"></script>
  <script src="assets/js/ai_compose.js"></script>
  <script src="assets/js/jquery.min.js"></script>
</head>

<body>
  <!-- é¡¶éƒ¨æ  -->
  <div class="top-bar">
    <div class="logo-container">
      <img src="assets/image/logo1.png" class="logo" alt="Logo">
      <div class="site-title">
        <span class="title-left">ç«¥å¿ƒæ±‡èšÂ·</span><span
          class="title-right">å®¢å®¶ä¼ æƒ…</span>
      </div>
    </div>
    <div class="top-links">
      <!-- æ£€æŸ¥æ˜¯å¦å·²ç™»å½• -->
      <script>
        if (sessionStorage.getItem("username")) {
          document.write('<a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>');
        } else {
          document.write('<a href="../log.html">ç™»å½•</a>');
          document.write('<a href="../index.html">æ³¨å†Œ</a>');
        }

        function logout () {
          sessionStorage.removeItem("username");
          window.location.href = "home.html";
        }
      </script>
      <a href="#">åŠ å…¥æ”¶è—</a>
      <a href="#">è®¾ä¸ºé¦–é¡µ</a>
    </div>
  </div>
  <!-- ä¸»å¯¼èˆªæ  -->
  <header>
    <nav>
      <ul>
        <li class="active"><a href="../æ•™è‚²æœåŠ¡&å…¬ç›Šå‚æ¼”/home.html">é¦–é¡µ</a></li>
        <li><a href="../æ•™è‚²æœåŠ¡&å…¬ç›Šå‚æ¼”/resource.html">èµ„æºå…±äº«</a></li>
        <li><a href="../å•†å“è´­ä¹°é¡µé¢/shouye.html">æ–‡åˆ›å‘å”®</a></li>
        <li><a href="../æ•™è‚²æœåŠ¡&å…¬ç›Šå‚æ¼”/performance.html">å…¬ç›Šå±•æ¼”</a></li>
        <li><a href="../æ•™è‚²æœåŠ¡&å…¬ç›Šå‚æ¼”/education.html">æ•™è‚²æœåŠ¡</a></li>
        <li><a href="../aiç¼–æ›²é¡µé¢ä¿¡æ¯/ai.html">AIç¼–æ›²</a></li>
        <li><a href="../æˆ‘çš„/wode.html">å…³äºæˆ‘ä»¬</a></li>
      </ul>
    </nav>
    <div class="search-login">
      <i class="fas fa-search search-icon"></i>
      <input type="text" placeholder="æœç´¢å®¢å®¶æ–‡åŒ–...">
    </div>
  </header>
  <div class="ai-content-wrapper">
    <!-- æ¨ªå¹…åŒºåŸŸ -->
    <section class="ai-banner">
      <div class="banner-text">
        <h1>AIç¼–æ›²æˆæœå±•ç¤º</h1>
        <p>èåˆç§‘æŠ€ä¸ä¼ ç»Ÿï¼Œè®©å®¢å®¶æ—‹å¾‹ç„•å‘æ–°å£°</p>
      </div>
    </section>
    <!-- AIéŸ³ä¹å±•ç¤ºåŒº -->
    <section class="music-gallery">
      <div class="music-card">
        <img src="assets/image/éŸ³ä¹1.png" alt="AIéŸ³ä¹1">
        <h3>å®¢å®¶æ™¨æ›²</h3>
        <audio controls class="music-player" src="assets/music/0 (1).wav"></audio>
      </div>
      <div class="music-card">
        <img src="assets/image/éŸ³ä¹2.png" alt="AIéŸ³ä¹2">
        <h3>ç”°å›­åˆå</h3>
        <audio controls class="music-player" src="assets/music/1 (1).wav"></audio>
      </div>
      <div class="music-card">
        <img src="assets/image/éŸ³ä¹3.png" alt="AIéŸ³ä¹3">
        <h3>æ•…ä¹¡æœˆä¸‹</h3>
        <audio controls class="music-player" src="assets/music/2 (1).wav"></audio>
      </div>
    </section>
    <!-- AIç¼–æ›²å°è¯•åŒº -->
    <section class="ai-compose-section">
      <h2 class="section-title">ğŸ¼ AIç¼–æ›²å®éªŒå®¤</h2>
      <div class="compose-controls">
        <div class="param-group">
          <label for="prompt"><i class="fas fa-comment"></i> è¯·è¾“å…¥æè¿°
            (prompt)</label>
          <textarea id="prompt" rows="3"
            placeholder="ä¾‹å¦‚ï¼šHakka folk song with guzheng, slow tempo"
            value="Hakka folk song"></textarea>
        </div>
        <div class="param-group">
          <label for="duration"><i class="fas fa-clock"></i> æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="duration" min="5" max="120" value="30">
        </div>
        <button id="generate-btn" class="hakka-btn primary" id="success">
          <i class="fas fa-magic"></i> ç«‹å³ç”Ÿæˆ </button>
      </div>
      <div class="result-container">
        <div class="loading-indicator" id="loading">
          <div class="hakka-spinner"></div>
          <p>ğŸµ æ­£åœ¨ç”Ÿæˆå®¢å®¶æ—‹å¾‹ï¼Œè¯·ç¨å€™...</p>
        </div>
        <div class="music-preview" id="preview">
          <audio id="generated-audio" controls></audio>
          <button id="download-btn" class="hakka-btn secondary">
            <i class="fas fa-download"></i> ä¸‹è½½éŸ³ä¹ </button>
        </div>
      </div>
    </section>
  </div>
  <!-- é¡µè„š -->
  <footer>
    <div class="footer-content">
      <p>Â© 2025 ç«¥å¿ƒæ±‡èšÂ·å®¢å®¶ä¼ æƒ… ç‰ˆæƒæ‰€æœ‰</p>
      <p>ä¼ æ‰¿å®¢å®¶æ–‡åŒ–ï¼Œå¼˜æ‰¬æ°‘æ—ç²¾ç¥</p>
    </div>
  </footer>
  <script>
    $(function () {
      const generateBtn = $('#generate-btn');
      const loadingIndicator = $('#loading');
      const preview = $('#preview');
      const audioElement = $('#generated-audio');
      const downloadBtn = $('#download-btn');
      let times = null;
      function showLoading (show) {
        loadingIndicator.css('display', show ? 'flex' : 'none');
        preview.css('display', show ? 'none' : 'flex');
      }

      generateBtn.on('click', function () {
        const prompt = $('#prompt').val().trim();
        const duration = parseInt($('#duration').val(), 10);

        if (!prompt) {
          alert('è¯·è¾“å…¥æè¿°å†…å®¹');
          return;
        }
        if (!duration || duration < 5 || duration > 120) {
          alert('è¯·è¾“å…¥5-120ç§’ä¹‹é—´çš„æŒç»­æ—¶é—´');
          return;
        }

        showLoading(true);
        // let result = {
        //   "status": "success",
        //   "taskid": "c177a837-0c26-49fc-a7c7-2b2c323b4bf4"
        // }

        $.ajax({
          url: 'http://127.0.0.1:3558/generate_hakka_music',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ prompt, duration }),
          success: function (response) {
            console.log(response)
            times = setInterval(function () {
              checkStatus(response.taskid)
            }, 3000)
            /* {
                "status": "success",
                "taskid": "c177a837-0c26-49fc-a7c7-2b2c323b4bf4"
              }
              */
            // showLoading(false);
            // const audioUrl = URL.createObjectURL(response);
            // audioElement.attr('src', audioUrl);
            // audioElement[0].load();
            // audioElement[0].play();
            let responsedata = 'http://127.0.0.1:3558/generated_audio/' + response.taskid + '.wav';

            // ä¸‹è½½éŸ³ä¹
            downloadBtn.on('click', function () {
              const a = document.createElement('a');
              a.href = response;
              a.download = responsedata;
              document.body.appendChild(a);
              a.click();
              a.remove();
            });
          },
          error: function () {
            showLoading(false);
            alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥åå°æœåŠ¡');
          }
        });
      });
      // è½®è¯¢æ¥å£/status/{task_id}
      // {
      //   "status": "success",
      //   "taskid": "c177a837-0c26-49fc-a7c7-2b2c323b4bf4"
      // }
      function checkStatus (taskId) {
        $.ajax({
          url: 'http://127.0.0.1:3558/check_status/' + taskId,
          type: 'GET',
          dataType: 'JSON',
          success: function (data) {
            console.log(data)
            if (data.status == 'completed') {
              let response = 'http://127.0.0.1:3558/generated_audio/' + taskId + '.wav';
              console.log(response)
              showLoading(false);
              // const audioUrl = URL.createObjectURL(response);
              // audioElement.attr('src', audioUrl);
              audioElement.attr('src', response);
              audioElement[0].load();
              audioElement[0].play();

              downloadBtn.on('click', function () {
                const a = document.createElement('a');
                a.href = response;
                a.download = response;
                document.body.appendChild(a);
                a.click();
                a.remove();
              });
              clearInterval(times);
              times = null;
            } else if (data.status == 'failed') {
              alert(data.error)
              showLoading(false);
              clearInterval(times);
              times = null;
            }
          },
          error: function () {
            showLoading(false);
            clearInterval(times);
            times = null;
            alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åå°æœåŠ¡');
          }
        })
      }
    })
  </script>
</body>

</html>

